# 장고 기초 복습~db model

> 글쓰니 김혜지
> 

/목

- 목차

---

## 환경 구축

```bash
$ python -m venv venv

$ source venv/Scripts/activate

$ pip list
Package    Version
---------- -------
pip        22.0.4 
setuptools 58.1.0

$ pip install django==3.2.13 # LT..오랜시간 사용된 3.2.13 버전 사용

$ pip freeze > reqirements.txt
```

```
asgiref==3.5.2
Django==3.2.13
pytz==2022.4
sqlparse==0.4.3
```

### 현재 폴더에 장고프로젝트 생성

```bash
$ django-admin startproject crud .
```

### 서버실행

```bash
$ python manage.py runserver
```

### 언어, 시간설정

```python
LANGUAGE_CODE = 'ko-kr'

TIME_ZONE = 'Asia/Seoul'
```

### application 생성

```bash
$ python manage.py startapp articles
```

### application 등록

```python
INSTALLED_APPS = [
    'articels',
	...
]
```

---

# 0. template 구조 설정

### urls 기능별로 분기

```python
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('articles/', include('articles.urls')),
]
```

```python
from django.urls import path
from . import views

urlpatterns = [
    path('', views.index)
]
```

앱의 urls.py파일에 이름을 붙이거나 내부의 path별로 이름을 붙여 사용할 수 있음 

```python
from django.urls import path
from . import views

app_name = 'articles'                       # 앱의 urls.py파일에 이름을 붙이거나
urlpatterns = [
    path('', views.index, name='index')     # 내부의 path별로 이름을 붙여 사용
]
```

### 페이지 넘겨주기

render(reqeust, 템플릿 이름)를 통해서 페이지 보여줌 

```python
from django.shortcuts import render

# Create your views here.
def index(request):
    # request에는 모든 요청정보가 들어있다.
    # path 함수에 views.index 함수 정보 넘겨주면서
    # path 함수 내부에서 호출할 때 첫번째 인자 넘겨준다.
    return render(request, 'articles/index.html') # templates/articles/index.html
```

### articels > templates > articles > 000.html

```python
{% extends 'base.html' %}
```

base.html을 찾을 수 있도록 settings.py에 설정

```python
TEMPLATES = [
    {
        ...,
        'DIRS': [BASE_DIR/'templates'],  # base 디렉토리에 templates폴더 생성
```

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>keymagic</title>
</head>
<body>
  {% block content %}{% endblock content %}
  {% block footer %}{% endblock footer %}
</body>
</html>
```

```html
{% extends 'base.html' %}

{% block contect %}
  <h1>INDEX PAGE</h1>

{% endblock contect %}
```

---

# 1. Article 모델 + 게시글 작성

### ARTICLE Model

```python
from django.db import models

# Create your models here.
class Article(models.Model):
    title = models.CharField(max_length = 50)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)        # 수정된 시간

    def __str__(self):
        return self.title
```

### migrations

```python
$ python manage.py makemigrations
Migrations for 'articles':
  articles\migrations\0001_initial.py
    - Create model Article
```

- articles 스키마 확인
    
    ```python
    # Generated by Django 3.2.13 on 2022-10-06 01:23
    
    from django.db import migrations, models
    
    class Migration(migrations.Migration):
    
        initial = True
    
        dependencies = [
        ]
    
        operations = [
            migrations.CreateModel(
                name='Article',
                fields=[
                    ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                    ('title', models.CharField(max_length=50)),
                    ('content', models.TextField()),
                    ('created_at', models.DateTimeField(auto_now_add=True)),
                    ('updated_at', models.DateTimeField(auto_now=True)),
                ],
            ),
        ]
    ```
    

### index 페이지에서 모든 게시물 표출

```python
from django.shortcuts import render
from .models import Article

# Create your views here. 
def index(request):
    # request에는 모든 요청정보가 들어있다.
    # path 함수에 views.index 함수 정보 넘겨주면서
    # path 함수 내부에서 호출할 때 첫번째 인자 넘겨준다.

    # SELECT * FROM articles_article
    # <Query SET [<Article object(1)>, ]>
    articles = Article.objects.all()            
    context = {
        'articles' : articles,
    }

    return render(request, 'articles/index.html', context) # templates/articles/index.html
```

```html
{% extends 'base.html' %}

{% block content %}
  <h1>INDEX PAGE</h1>

  {% comment %} DTL 사용해서 article 리스트로 표출 {% endcomment %}
  {% comment %} 각각의 article은 article클래스 인스턴스 {% endcomment %}
  {% comment %} {{}} 중괄호 두 개로 변수를 사용할 수 있음 {% endcomment %}
  {% for article in articles %}
    <p>{{ article.pk }}번 째 글</p>
    <p>제목 : {{article.title}}</p>
  {% endfor %}

{% endblock content %}
```

### [해결] 에러 발생_에러메세지를 잘 읽자

```bash
You have 19 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): admin, articles, auth, contenttypes, sessions.
Run 'python manage.py migrate' to apply them.
```

migration다시해줘야함

아ㅣㄴ닌데..

`$ python [manage.py](http://manage.py/) makemigrations
No changes detected`

```bash
$ python manage.py migrate
```

해결..

### url

```python
from django.urls import path
from . import views

app_name = 'articles'
urlpatterns = [
    path('', views.index, name='index'),
    path('create/', views.create, name='create'),
]
```

### form 상속받아서 재정의

```python
.from django import forms
from .models import Article

class ArticleForm(forms.ModelForm):
    # ArticleForm Class 가 어떻게 정의되는지 
    # 그 정보는 Meta class에 넣는다 
    class Meta:
        model = Article
				fields = "**all**"       # article의 모든 필드를 포함한다는 뜻. 빼먹으면 오류남. 빼먹지 말기..
```

### 만든 form을 index로 넘겨주기

```python
from .models import Article
from .forms import ArticleForm

def create(request):
    form = ArticleForm
    context = {
        'form' : form
    }
    return render(request, 'articles/create.html', context)
```

### create 페이지에서 표출

```html
{% extends 'base.html' %}

{% block content %}
  <h1>CREATE PAGE</h1>

  <form action="" method="POST">
    {% csrf_token %}
    {{ form }} => {{ form.as_p }}
		<input type="submit" value="글 생성">
  </form>
  <a href="{% url 'articles:index' %}">[게시글 생성]</a>

{% endblock content %}
```

### index에서 create 연결

```html
<a href="/articles/create/">[게시글 생성]</a>

=> 하드코딩 멈춰

<a href="{% url 'articles:create' %}">[게시글 생성]</a>
# app name:path name
```

### POST 요청만 처리하도록

```python
def create(request):
    if request.method ==  'POST':
        pass
    else:
        form = ArticleForm()
    context = {
        'form' : form
    }
    return render(request, 'articles/create.html', context)
```

```python
from django.shortcuts import render, redirect
from .models import Article
from .forms import ArticleForm

def index(request):...
def create(request):
    if request.method ==  'POST':
        # 사용자가 POST 요청을 보낼 때 같이 보낸 정보들
        # model에 대한 정보와 form에대한 정보 모두 가지고있는
        # ArticleForm에게 사용자의 요청 정보를 같이 넘겨줘서
        form = ArticleForm(request.POST)    # key, value 값 알아서 매칭해줌
        # 사용자가 보낸 정보다 정상적인 데이터인지 확인
        # 왜 ? sqlite 스키마 무시하고 데이터 넣는대로 다 받아버림;
        # DB에 넣기 전에 사용자가 입력한 데이터를 확인..!
        if form.is_valid(): 
            form.save()
            return redirect('articles:index')
    else:
        form = ArticleForm()
    context = {
        'form' : form
    }
    return render(request, 'articles/create.html', context)
```

## 게시글 상세페이지

### variable routing 게시글 번호로 상세페이지 접근

```bash
from django.urls import path
from . import views

app_name = 'articles'
urlpatterns = [
    path('', views.index, name='index'),
    path('create/', views.create, name='create'),
    # variable routing
    path('<int:article_pk>/', views.detail, name='detail'),
]
```

### detail()

```python
def detail(request, article_pk): # (주의) url에 정의한 변수명과 일치해야함
    article = Article.objects.get(pk= article_pk)
		# article에 pk 값에 일치하는 article.title, article.content 가 들어있음
    context = {
        'article' : article,
    }
    return render(request, 'articles/detail.html', context)
```

### detail.html

```python
{% extends 'base.html' %}

{% block content %}
  <h1>DETAIL PAGE</h1>

  
  <p>{{ article.pk }}번 째 글</p>
  <hr>
  <p>제목 : {{article.title}}</p>
  <p>내용 : {{article.content}}</p>
  <p>작성 시간 : {{article.created_at}}</p>
  <p>수정 시간 : {{article.updated_at}}</p>
  <hr>
  <a href="{% url 'articles:index' %}">[글 목록]</a>
  
{% endblock content %}
```

### 글 목록에서 상세페이지로 연결

```html
<!-- {% url '경로' 인자 %} -->
<a href="{% url 'articles:detail' article.pk %}">
    <p>{{ article.pk }}번 째 글</p>
    <p>제목 : {{article.title}}</p>
</a>
```

---

# 2. User모델 + 로그인 기능

- 유저 정보 필요

-이미 migrate할때 장고가 auth_user 모델을 만들어주는데
따로 User Model 을 만들어서 사용할 것임

### accounts 어플리케이션 만들기

```
$ python manage.py startapp accounts
```

### 어플리케이션 등록하기

```python
INSTALLED_APPS = [
    'articles',
    'accounts',
```

```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('articles/', include('articles.urls')),
    path('accounts/', include('accounts.urls')),
]
```

### 회원가입 페이지

```python
from django.urls import path
from . import views

app_name = 'accounts'

urlpatterns = [
    path('signup/', views.signup, name='signup')
]
```

```python
from django.shortcuts import render

def signup(request):
    return render(request, 'accounts/signup.html')
```

### User 모델 만들어주기

### AUTH_USER_MODEL 원래 장고의 유저모델 덮어쓰기

```python
AUTH_USER_MODEL = 'accounts.User'
```

db.sqlite3 파일 지우고 새로 migration > migrate 하면 된다

### migration해야죠 migrate또 까먹지 말고!

```bash
$python manage.py makemigrations
$python manage.py migrate
```

### 장고의 회원가입 폼 view함수에서 바로 사용하기

```python
from multiprocessing import context
from django.shortcuts import render
from django.contrib.auth.forms import UserCreationForm

def signup(request):
    form = UserCreationForm()
    context={
        'form':form,
    }
    return render(request, 'accounts/signup.html', context)
```

```html
{% extends 'base.html' %}

{% block content %}
<h1>Sign Up Page</h1>
<form action="" method="POST">
  {% csrf_token %}
  {{form.as_p}}

  <input type="submit" value="signup">

</form>
<a href="{% url 'articles:index' %}"></a>

{% endblock content %}
```

### base html에 회원가입 버튼 추가

```html
<h3><a href="{% url 'accounts:signup' %}">회원가입</a></h3>
```

### signup()에서 POST 요청 확인

```python
from multiprocessing import context
from django.shortcuts import render,redirect
from django.contrib.auth.forms import UserCreationForm

def signup(request):
    if request.method == 'POST':
        form = UserCreationForm(request.POST)
        if form.is_valid():
            form.save()
            return redirect('articles:index')
    else:
        form = UserCreationForm()
    context={
        'form':form,
    }
    return render(request, 'accounts/signup.html', context)
```

### UserCreationForm에서 정보가 변경된 것을 알아야함. form에서 재정의

```python
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth import get_user_model # 현재 활성화되어있는 user 모델을 가져와주는 get_user_model

class CustumUserCreationForm(UserCreationForm):
    class Meta(UserCreationForm.Meta):
        model = get_user_model()
        fields = UserCreationForm.Meta.fields
```

```python
from multiprocessing import context
from django.shortcuts import render,redirect
from django.contrib.auth.forms import UserCreationForm
from .forms import CustomUserCreationForm

def signup(request):
    if request.method == 'POST':
        form = CustomUserCreationForm(request.POST)
        if form.is_valid():
            form.save()
            return redirect('articles:index')
    else:
        form = CustomUserCreationForm()
    context={
        'form':form,
    }
    return render(request, 'accounts/signup.html', context)
```

### User객체 를 담아서 회원가입 시 로그인 해주기

```python
from multiprocessing import context
from django.shortcuts import render,redirect
from django.contrib.auth.forms import UserCreationForm
from .forms import CustomUserCreationForm
from django.contrib.auth import login as auth_login

def signup(request):
    if request.method == 'POST':
        form = CustomUserCreationForm(request.POST)
        if form.is_valid():
            user = form.save()
            auth_login(request, user)
            return redirect('articles:index')
    else:
        form = CustomUserCreationForm()
    context={
        'form':form,
    }
    return render(request, 'accounts/signup.html', context)
```

### 로그인 한 상태 base.html에 표시하기

```python
{% if request.user.is_authenticated %} # anonymous user 거르기위한 is_authenticated 
    <p>{{user}}</p>
    {% else %}
    <a href="{% url 'accounts:signup' %}">[회원가입]</a>
    {% endif %}
```

## 로그아웃

### url

```python
path('logout/', views.logout, name='logout'),
```

### 장고의 logout()기능 사용하기_ logout()

```python
from django.contrib.auth import logout as auth_logout
...
def logout(request):
    # 로그인 세션을 파기하는 과정
    if request.user.is_authenticated:
        auth_logout(request)
		return redirect('accounts:index')
```

### 로그아웃 버튼

```python
{% if request.user.is_authenticated %}
    <p>{{user.username}}</p>
    <form action="{% url 'accounts:logout' %}" method="POST">
      {% csrf_token %}
      <input type="submit" value="로그아웃">
    </form>
```

### POST요청만 받도록 decorator 사용하기

```python
from django.views.decorators.http import require_POST

@require_POST
def logout(request):
    # 로그인 세션을 파기하는 과정
    # if request.method == "POST": # 이거 대신에 데코레이터 사용하는거
    if request.user.is_authenticated:
        auth_logout(request)
    return redirect('accounts:index')
```

## 로그인

### url

```python
path('login/', views.login, name='login'),
```

### login()

```python
from django.contrib.auth.forms import AuthenticationForm
...
def login(request):
    form = AuthenticationForm()
    context = {
        'form' : form
    }
    return render(request, 'accounts/login.html', context)

```

### login 페이지 뷰단

```python
{% extends 'base.html' %}

{% block content %}
<h1>Login PAGE</h1>
<form action="" method="POST">
  {% csrf_token %}
  {{form.as_p}}
  <input type="submit" value="LOGIN">
</form>

{% endblock content %}
```

### base.html에서 로그아웃 상태에서 로그인 버튼추가

```python
{% if request.user.is_authenticated %}
...
    {% else %}
    <a href="{% url 'accounts:login' %}">[로그인]</a>
```

### AuthenticationForm 의 첫번째 인자로 request를 넘겨줘야한다

```python
def login(request):
    if request.method == "POST":
        form = AuthenticationForm(request, request.POST)
        if form.is_valid():         # 유저정보
            auth_login(request, form.get_user()) # 로그인!
						return redirect('articles:index')
    else:
        form = AuthenticationForm()
    context = {
        'form' : form
    }
    return render(request, 'accounts/login.html', context)
```

---

# 3. Comments모델 + 댓글 작성

- 게시글 정보, 유저정보 필요

-게시글 : 댓글 = 1:N

-유저:댓글 = 1:N

### Comment 모델

```python
class Comment(models.Model):
    # 변수명 : 내가 참조하고 있는 대상의 이름을 소문자로 만들면 
    # table에서는 컬럼명_id로 컬럼 생성된다
    article = models.ForeignKey(Article, on_delete= models.CASCADE)
    content = models.TextField()
    created_at = models.DateField(auto_now_add=True)

    def __str__(self):
        return self.content
```

### migration해야죠 migrate또 까먹지 말고!

```bash
$python manage.py makemigrations
$python manage.py migrate
```

### 댓글생성 → 게시글 상세 조회 페이지에서

```html
<p>-comments-</p>
  <form action="" method='POST'>
    {% csrf_token %}
    {{ form.as_p}}
    <input type="submit" value="댓글 생성">
  </form>

{% endblock content %}
```

### 댓글 폼 만들어주기

```python
from dataclasses import fields
from django import forms
from .models import Article, Comment

class ArticleForm(forms.ModelForm):...
class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        fields = '__all__'
```

### 상세페이지에서 댓글 폼 표출

```python
from .forms import ArticleForm, CommentForm

def index(request):...
def create(request):...
def detail(request, article_pk): # (주의) url에 정의한 변수명과 일치해야함
    article = Article.objects.get(pk= article_pk)
    # article에 pk 값에 일치하는 article.title, article.content 가 들어있음
    form = CommentForm()
    context = {
        'article' : article,
        'form' : form,
    }
    return render(request, 'articles/detail.html', context)
```

### comment 필드에 있는 article 정보가 댓글 form에서 표출되지 않게 만들기

```python
class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        # fields = '__all__'
        exclude = ('article',)
```

### 댓글 생성하는 곳으로 요청 보내기

```python
path('<int:article_pk>/comments/create/', views.comment_create, name='comment_create'),
```

```html
<form action="{% url 'articles:comment_create' article.pk %}" method='POST'>
    {% csrf_token %}
    {{ form.as_p}}
    <input type="submit" value="댓글 생성">
  </form>
```

```python
def comment_create(request, article_pk):
    if request.method ==  'POST':
        form = CommentForm(request.POST)
        if form.is_valid():
            form.save()
    return redirect('articles:detail',article_pk)
```

### 이상태로 진행하면 Integrity Error 발생

![제목 없음.png](%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%80%E1%85%A9%20%E1%84%80%E1%85%B5%E1%84%8E%E1%85%A9%20%E1%84%87%E1%85%A9%E1%86%A8%E1%84%89%E1%85%B3%E1%86%B8~db%20model%202dcef44b4b0345bda7896f7a0b733b61/%25EC%25A0%259C%25EB%25AA%25A9_%25EC%2597%2586%25EC%259D%258C.png)

### comment_create() 에서  저장 전에 article 정보 담아주기

```python
def comment_create(request, article_pk):
    article =  Article.objects.get(pk=article_pk)
    if request.method ==  'POST':
        form = CommentForm(request.POST)
        if form.is_valid():
            # comment 객체 생성
            # 저장해서 생성하는데 db에 반영이 안되도록
            comment = form.save(commit=False)
            comment.article = article
						comment.save()
    return redirect('articles:detail',article_pk)
```

### 게시글에는 댓글에 대한 정보가 없는데 어떻게 연결??

objects = 객체 매니저

‘relatedModelName’_set = 역참조 객체 매니저 (참조 모델명은 소문자로)

### 생성된 댓글 표출하기

```html
{% for comment in article.comment_set.all %}
    <hr>
    <p>{{comment.content}} | {{comment.created_at}} </p>
{% endfor %}
```

---

# 4. User + Article

### Article Model에 재정의 한 user 연결

```python
from django.conf import settings

class Article(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete = models.CASCADE)
...
```

### articles 변동사항만 적용하도록! migration, migrate

```bash
$python manage.py makemigrations articles
```

이러면 존재하는 유저정보가 있기때문에 오류가남! 

```
You are trying to add a non-nullable field 'user' to article without a default; we can't do that (the database needs something to populate existing rows).
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
 2) Quit, and let me add a default in models.py
```

```bash
다시
$python manage.py makemigrations articles
$python manage.py migrate
```

### 와악

### article creation form 에서 유저 정보에 대한 자동완성 제거해주기

```python
class ArticleForm(forms.ModelForm):
    # ArticleForm Class 가 어떻게 정의되는지 
    # 그 정보는 Meta class에 넣는다 
    class Meta:
        model = Article
        # fields = "__all__"
        exclude = ('user',)
```

### 유저 정보가 같이 저장되도록 게시글 생성 함수create()에서 user정보 같이 담아주기

```python
if form.is_valid(): 
            article = form.save(commit=False)
            article.user = request.user
            article.save()
            return redirect('articles:index')
```

### index 에 유저 정보추가

```bash
{% for article in articles %}
    <hr>
    <a href="{% url 'articles:detail' article.pk %}">
      <p>작성자 : {{ article.user }}</p>
      <p>{{ article.pk }}번 째 글</p>
      <p>제목 : {{article.title}}</p>
    </a>
  {% endfor %}
```

### 로그인을 안 한 상태로 게시글 작성했을 때 로그인 페이지로 redirect

```python
@login_required
def create(request):
    ...
    return render(request, 'articles/create.html', context)
```

### 로그인 필수 데코레이터 사용 @login_required

```python
from django.contrib.auth.decorators import login_required

@login_required
def create(request):
```

### request에 next가 있으면 redirect

```python
return redirect(request.Get.get('next') or 'articles:index') 
# 없으면 articles의 index로 
```

### 게시글 삭제

### urls

```python
path('<int:article_pk>/delete/', views.delete, name='delete')
```

### delete()

```python
from django.views.decorators.http import require_POST

@require_POST
def delete(request, article_pk):
    article = Article.objects.get(pk=article_pk)
    article.delete()
    return redirect('articles:index')
```

### 게시글 삭제 버튼

```python
<form action="{% url 'articles:delete' article.pk %}" method="POST">
    {% csrf_token %}
    <input type="submit" value="글 삭제">
  </form>
  {% endfor %}
```

### 글쓴이 인증하고 게시글 삭제 할 수 있도록 구현

```python
@require_POST
# @login_required
def delete(request, article_pk):
    if request.user.is_authenticated:
        article = Article.objects.get(pk=article_pk)
        if article.user == request.user:  # 게시글이 가진 유저정보와 요청을 보낸 유저정보가 일치하는지 확인
            article.delete()
        return redirect('articles:index')
    return redirect('accounts:login')
```

### 글 삭제할 때 글쓴이 일치하면 삭제 버튼이 보이도록 뷰 구현

```python
{% if article.user == request.user %}
      <form action="{% url 'articles:delete' article.pk %}" method="POST">
        {% csrf_token %}
        <input type="submit" value="글 삭제">
      </form>
{% endif %}
```